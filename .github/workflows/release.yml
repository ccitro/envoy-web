name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  verify-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify manifest version matches tag
        run: |
          python3 - <<'PY'
          import json
          import os
          import re
          import sys

          tag = os.environ.get("GITHUB_REF_NAME", "")
          if not tag.startswith("v"):
            print(f"Unexpected tag: {tag}", file=sys.stderr)
            sys.exit(1)
          version = tag[1:]
          with open("custom_components/envoy_web/manifest.json", "r", encoding="utf-8") as fh:
            data = json.load(fh)
          manifest_version = data.get("version", "")
          if manifest_version != version:
            print(
              f"Manifest version {manifest_version} does not match tag {version}",
              file=sys.stderr,
            )
            sys.exit(1)
          PY

      - name: Generate release notes
        run: |
          set -euo pipefail

          tag="${GITHUB_REF_NAME}"
          prev_tag="$(git describe --tags --abbrev=0 "${tag}^" 2>/dev/null || true)"

          {
            echo "## What's Changed"
            if [[ -n "${prev_tag}" ]]; then
              git log "${prev_tag}..${tag}" --pretty=format:"- %s (%h)"
              echo
              echo
              echo "Full Changelog: https://github.com/${GITHUB_REPOSITORY}/compare/${prev_tag}...${tag}"
            else
              git log "${tag}" --pretty=format:"- %s (%h)"
            fi
          } > release_notes.md

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
