#!/usr/bin/env bash

set -e

cd "$(dirname "$0")/.."

VENV_DIR="${VENV_DIR:-.venv}"

if [[ ! -d "${VENV_DIR}" ]]; then
    python3 -m venv "${VENV_DIR}"
fi

# shellcheck disable=SC1091
source "${VENV_DIR}/bin/activate"

# Install runtime + test requirements if not already installed
if ! python -c "import pytest" 2>/dev/null; then
    echo "Installing test requirements..."
    if command -v uv >/dev/null 2>&1; then
        uv pip install --requirement requirements.txt --requirement requirements_test.txt
    else
        python -m pip install --requirement requirements.txt --requirement requirements_test.txt
    fi
fi

# Run tests
python -m pytest tests/ "$@"
